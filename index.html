<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SurveyGrid Pro</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.8.0/proj4.js"></script>
    <style>
        body { margin: 0; font-family: sans-serif; }
        #map { height: 100vh; width: 100vw; }
        .controls {
            position: absolute; top: 10px; left: 10px; z-index: 1000;
            background: white; padding: 15px; border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2); width: 250px;
        }
        .control-group { margin-bottom: 10px; }
        label { display: block; font-size: 12px; color: #666; }
        input { width: 100%; margin-top: 4px; }
        button { 
            width: 100%; padding: 10px; background: #007bff; 
            color: white; border: none; border-radius: 4px; cursor: pointer;
            margin-top: 10px;
        }
        button:hover { background: #0056b3; }
        .export-btn { background: #28a745; }
    </style>
</head>
<body>

<div class="controls">
    <h3>SurveyGrid Tool</h3>
    <div class="control-group">
        <label>Grid Spacing (m)</label>
        <input type="number" id="spacing" value="10">
    </div>
    <div class="control-group">
        <label>Rotation (Â°)</label>
        <input type="range" id="rotation" min="0" max="360" value="0">
    </div>
    <button onclick="setGridCenter()">Place Grid at Center</button>
    <button class="export-btn" onclick="exportDXF()">Export DXF (OSGB36)</button>
    <p style="font-size: 10px; color: #888;">Note: Proj4 handles WGS84 to OSGB36 conversion for DXF output.</p>
</div>

<div id="map"></div>

<script>
    // Define OSGB36 projection for Export
    proj4.defs("EPSG:27700", "+proj=tmerc +lat_0=49 +lon_0=-2 +k=0.9996012717 +x_0=400000 +y_0=-100000 +ellps=airy +datum=OSGB36 +units=m +no_defs");

    const map = L.map('map').setView([51.505, -0.09], 13);
    
    const satellite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
        attribution: 'Tiles &copy; Esri'
    }).addTo(map);

    let gridLayer = L.layerGroup().addTo(map);
    let centerMarker;

    function setGridCenter() {
        const center = map.getCenter();
        if (centerMarker) map.removeLayer(centerMarker);
        centerMarker = L.marker(center, {draggable: true}).addTo(map);
        centerMarker.on('drag', drawGrid);
        drawGrid();
    }

    function drawGrid() {
        gridLayer.clearLayers();
        if (!centerMarker) return;

        const center = centerMarker.getLatLng();
        const spacing = parseFloat(document.getElementById('spacing').value) / 111320; // Approx meters to deg
        const rotation = document.getElementById('rotation').value * (Math.PI / 180);

        // Simple 5x5 grid visualization
        for (let i = -2; i <= 2; i++) {
            for (let j = -2; j <= 2; j++) {
                const lat = center.lat + (i * spacing);
                const lng = center.lng + (j * spacing);
                
                L.circle([lat, lng], {radius: 1, color: 'blue'}).addTo(gridLayer);
            }
        }
    }

    function exportDXF() {
        if (!centerMarker) {
            alert("Place a grid first!");
            return;
        }
        
        const pos = centerMarker.getLatLng();
        const osgb = proj4("EPSG:4326", "EPSG:27700", [pos.lng, pos.lat]);
        
        let dxfContent = `0\nSECTION\n2\nENTITIES\n`;
        // Dummy DXF point for the center
        dxfContent += `0\nPOINT\n8\nGRID_LAYER\n10\n${osgb[0]}\n20\n${osgb[1]}\n30\n0.0\n62\n5\n`;
        dxfContent += `0\nENDSEC\n0\nEOF`;

        const blob = new Blob([dxfContent], {type: 'application/dxf'});
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = "survey_export.dxf";
        link.click();
    }

    document.getElementById('rotation').oninput = drawGrid;
    document.getElementById('spacing').oninput = drawGrid;

    // GPS Location
    map.locate({setView: true, maxZoom: 16});
</script>

</body>
</html>
